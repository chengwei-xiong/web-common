## IM的同步和存储模型

### 概述

IM系统中最核心的部分是消息系统，消息系统中最核心的功能是消息的同步和存储：

* 消息的同步：将消息完整的、快速的从发送方传递到接收方，就是消息的同步。消息同步系统最重要的衡量指标就是消息传递的实时性、完整性以及能支撑的消息规模。从功能上来说，一般至少要支持在线和离线推送，高级的IM系统还支持『多端同步』。
* 消息的存储：消息存储即消息的持久化保存，这里不是指消息在客户端本地的保存，而是指云端的保存，功能上对应的就是『消息漫游』。『消息漫游』的好处是可以实现账号在任意端登陆查看所有历史消息，这也是高级IM系统特有的功能之一。
### Timeline模型
是一个存储消息队列的逻辑模型，每一个消息都有一个唯一的消息ID，可以通过该ID取得某一个消息或者一定范围内的消息。

### 同步模型
消息的实时同步模型是分为以下两种实现模式：

* 读扩散模型
	
	读扩散模式下是以会话为一个TimeLine模型单元进行存储的，拉取数据的时候，任何一个用户都是去对应的会话TimeLine模型中拉取数据；
	
	消息存储模型中，每个会话的Timeline中保存了这个会话的全量消息。读扩散的消息同步模式下，每个会话中产生的新的消息，只需要写一次到其用于存储的Timeline中，接收端从这个Timeline中拉取新的消息。优点是消息只需要写一次，相比写扩散的模式，能够大大降低消息写入次数，特别是在群消息这种场景下。但其缺点也比较明显，接收端去同步消息的逻辑会相对复杂和低效。接收端需要对每个会话都拉取一次才能获取全部消息，读被大大的放大，并且会产生很多无效的读，因为并不是每个会话都会有新消息产生。
* 写扩散模型
	
	写扩散模型下是以用户为一个TimeLine模型单元进行存储的,所有与任一用户会话的消息，都存储在一个TimeLine模型单元中，用户去自己的TimeLine模型单元中拉取自己的消息。
	
	写扩散的消息同步模式，需要有一个额外的Timeline来专门用于消息同步，通常是每个接收端都会拥有一个独立的同步Timeline，用于存放需要向这个接收端同步的所有消息。每个会话中的消息，会产生多次写，除了写入用于消息存储的会话Timeline，还需要写入需要同步到的接收端的同步Timeline。在个人与个人的会话中，消息会被额外写两次，除了写入这个会话的存储Timeline，还需要写入参与这个会话的两个接收者的同步Timeline。而在群这个场景下，写入会被更加的放大，如果这个群拥有N个参与者，那每条消息都需要额外的写N次。写扩散同步模式的优点是，在接收端消息同步逻辑会非常简单，只需要从其同步Timeline中读取一次即可，大大降低了消息同步所需的读的压力。其缺点就是消息写入会被放大，特别是针对群这种场景。

![读写模式](https://pic4.zhimg.com/80/v2-b16eaba67e2b427a7a931126fdd7e649_hd.jpg)

### 存储持久化模型
消息的存储模型是对消息进行持久化，他会保存消息的全量数据，他是以会话为一个基本的TimeLine单元进行存储，比如：A->B,B->C，group1,group2；如下图：

![基于TimeLine的消息存储模型](https://pic2.zhimg.com/80/v2-555385b5aad795d969f46a8f9f726bf6_hd.jpg)