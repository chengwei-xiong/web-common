## 分布式治理方案

### 容错
概述：分布式服务系统的调用面临着几种情况：成功，超时，失败，因此对于调用发起方而言做好容错是十分关键的，因为对其而言，提供商是透明的。
#### 面临的问题与场景
* 通信链路层的故障：提供者和消费者之间是维持的长连接，所有可能由于网络或者来自硬件的问题，导致通信中断的情况，大致的情况可能有以下几种：
	* 被调用者宕机
	* 网络波动产生的闪断
	* 心跳超时

* 服务调用失败：调用时发生的除了业务异常意外的异常
* 服务调用超时：调用时耗时过长，导致的超时

#### 容错策略
针对以上的不可靠场景，所以需要根据不同的业务场景进行容错，有以下几种容错策略：

* 失败自动切换（Failover）
* 失败通知（FailBack）
* 失败缓存（FailCache）
* 快速失败（FailFast）
* 容错策略扩展


### 服务路由

### 流量控制
----
概述：

##### 静态流控
在分布式协调系统中（注册中心），在服务启动的时候初始化一个总的阈值，然后为每一个实例按照一定的分配算法来分配各个实例的阈值，然后根据该阈值来做流量控制，该方案的最大问题是不能动态的根据实例运行期的状况来做流量控制,另外就是在增加实例或者实例宕机时需要重新计算并分配。

在这基础之上优化：在注册中心为每一个服务初始化一个流量资源池，每一个实例根据自身的情况去注册中心获取资源，这个操作是定期的（周期T），这样的话，服务实例可以根据自身的资源情况来申请资源。
##### 动态流控
  流控因子：

    * 系统资源:实例所在主机/vm的cpu使用率，内存使用率，网络带宽情况
	* 应用资源:实例的进程级资源，比如JVM的堆栈内存使用情况，消息队列积压率，会话积压率

  分级流控：
	
	* 不同流量的状态下（根据流控因子作为参考，多次取平均值）流控有不同的策略，根据预估的流量做出合理的流控分级策略。

##### 并发控制
并发控制的目的是针对线程的并发执行数进行控制，也就是访问线程数过多，导致的资源过度的消耗，导致服务本身或者拖垮其他的服务，其实这块涉及到的还有服务的隔离（线程级别），并发控制有两种：

* 针对服务者的全局并发控制：
在服务端针对没有个服务执行都隔离在一个单独的线程池中，设置合理的线程池数，然后针对过载的服务直接返回异常或者返回默认结果
* 针对消费者的单个服务的局部并发控制
消费者针对没一个单独的服务进行并行执行线程数的控制。

##### 连接控制
由于服务提供者和消费者都是通过长连接进行通信，所有过多的TCP长连接会占据服务提供者过多的资源，所以需要针对这块做流量控制。
服务提供者和消费者都可以针对单一服务进行连接数流控。

### 服务降级
----
概述：

#### 容错降级（熔断降级）
容错降级一般针对的是消费者在发起远程服务调用的时候，受网络，提供者报错等诸多原因，导致的消费者无法及时和正确的响应，所进行的降级策略，也叫做熔断降级，该降级的场景就是，一旦消费者调用服务发生超时，返回错误（异常）时进行降级策略，比如返回指定的异常，或者执行本地MOCK接口。
当然这个过程也可以和屏蔽降级的方式一样通过服务治理的管理端进行控制，流程大致和其类似。

#### 屏蔽降级
直接通过服务治理端选择降级的服务并选择降级的策略（返回null,返回指定异常，执行恩地MOCK接口），然后通知注册中心，然后通过注册中心的通知事件告知服务提供者和消费者，提供者进行更改状态为屏蔽降级，消费者更新状态为启用降级策略，根据通知的策略来进行降级。

#### 业务层降级
业务层降级是单体或者实例本身进行本地调用的时候进行的降级策略。

### 分布式服务治理

### 分布式链路跟踪与分析

### 高可用（监控机制）

